name: Database Migrations

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        type: choice
        options:
          - staging
          - production
      confirm:
        description: 'Type "CONFIRM" to proceed with migration'
        required: true
        type: string

jobs:
  validate:
    name: Validate Input
    runs-on: ubuntu-latest
    steps:
      - name: Check confirmation
        if: ${{ github.event.inputs.confirm != 'CONFIRM' }}
        run: |
          echo "❌ Migration not confirmed. Please type 'CONFIRM' to proceed."
          exit 1
          
      - name: Confirm migration
        run: echo "✅ Migration confirmed for ${{ github.event.inputs.environment }}"

  migrate:
    name: Run Migrations
    runs-on: ubuntu-latest
    needs: validate
    environment: ${{ github.event.inputs.environment }}
    steps:
      - uses: actions/checkout@v4
      
      - uses: pnpm/action-setup@v3
        with:
          version: 9
          
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'
          
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
        working-directory: workers
        
      - name: List pending migrations
        run: npx wrangler d1 migrations list DB --env ${{ github.event.inputs.environment }} || npx wrangler d1 migrations list DB
        working-directory: workers
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          
      - name: Apply migrations
        run: npx wrangler d1 migrations apply DB --env ${{ github.event.inputs.environment }} || npx wrangler d1 migrations apply DB
        working-directory: workers
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          
      - name: Verify migrations
        run: |
          echo "✅ Migrations applied successfully to ${{ github.event.inputs.environment }}"
