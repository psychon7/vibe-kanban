name: Deploy to Staging

on:
  push:
    branches: [develop]
    paths:
      - 'workers/**'
  workflow_dispatch:

concurrency:
  group: staging-deploy
  cancel-in-progress: true

jobs:
  deploy-backend:
    name: Deploy Backend API to Staging
    runs-on: ubuntu-latest
    environment: staging
    steps:
      - uses: actions/checkout@v4
      
      - uses: pnpm/action-setup@v3
        with:
          version: 9
          
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'
          
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
        working-directory: workers
        
      - name: Type check
        run: npx tsc --noEmit
        working-directory: workers
        
      - name: Deploy to Cloudflare Workers (Staging)
        run: npx wrangler deploy --env staging || npx wrangler deploy
        working-directory: workers
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

  deploy-frontend:
    name: Deploy Frontend to Staging
    runs-on: ubuntu-latest
    environment: staging
    needs: deploy-backend
    steps:
      - uses: actions/checkout@v4
      
      - uses: pnpm/action-setup@v3
        with:
          version: 9
          
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'
          
      - name: Install dependencies
        run: npm install
        working-directory: workers/frontend
        
      - name: Build frontend
        run: npm run build
        working-directory: workers/frontend
        env:
          VITE_API_URL: ${{ vars.VITE_API_URL_STAGING || 'https://vibe-kanban-api-staging.sheshnarayan-iyer.workers.dev' }}
        
      - name: Deploy to Cloudflare Pages (Staging branch)
        run: npx wrangler pages deploy dist --project-name=vibe-kanban --branch=staging --commit-dirty=true
        working-directory: workers/frontend
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
