# ═══════════════════════════════════════════════════════════════════════════════
# Vibe Kanban API - Cloudflare Workers Configuration
# ═══════════════════════════════════════════════════════════════════════════════
# Documentation: https://developers.cloudflare.com/workers/configuration/

name = "vibe-kanban-api"
main = "src/index.ts"
compatibility_date = "2024-01-01"
compatibility_flags = ["nodejs_compat"]

# ─────────────────────────────────────────────────────────────────────────────
# D1 Database Binding (Development)
# ─────────────────────────────────────────────────────────────────────────────

[[d1_databases]]
binding = "DB"
database_name = "vibe-kanban-db"
database_id = "161a7750-7a11-4fa8-961c-3417afcc52c1"
migrations_dir = "migrations"

# ─────────────────────────────────────────────────────────────────────────────
# R2 Storage Binding (avatars, exports, attachments)
# ─────────────────────────────────────────────────────────────────────────────

[[r2_buckets]]
binding = "STORAGE"
bucket_name = "vibe-kanban-storage"

# ─────────────────────────────────────────────────────────────────────────────
# KV Namespace Binding (session cache, rate limiting)
# Create: wrangler kv:namespace create CACHE
# ─────────────────────────────────────────────────────────────────────────────

[[kv_namespaces]]
binding = "CACHE"
id = "6ea26d2a95aa460da9ae6685b8a23b06"

# ─────────────────────────────────────────────────────────────────────────────
# AI Gateway Configuration
# ─────────────────────────────────────────────────────────────────────────────

[ai]
binding = "AI"

# ─────────────────────────────────────────────────────────────────────────────
# Durable Objects
# ─────────────────────────────────────────────────────────────────────────────

[[durable_objects.bindings]]
name = "LOCAL_AGENT_RELAY"
class_name = "LocalAgentRelay"

[[migrations]]
tag = "v1" # Should be unique for each migration
new_classes = ["LocalAgentRelay"]

# ─────────────────────────────────────────────────────────────────────────────
# Environment Variables (Development)
# ─────────────────────────────────────────────────────────────────────────────

[vars]
ENVIRONMENT = "development"
LOG_LEVEL = "debug"
CORS_ORIGIN = "http://localhost:5173"

# ─────────────────────────────────────────────────────────────────────────────
# Secrets (set via: wrangler secret put <SECRET_NAME>)
# ─────────────────────────────────────────────────────────────────────────────
# Required secrets:
# - JWT_SECRET: For JWT token signing
# - OPENAI_API_KEY: For prompt enhancement (optional)
# - ANTHROPIC_API_KEY: For Claude integration (optional)

# ═══════════════════════════════════════════════════════════════════════════════
# STAGING ENVIRONMENT
# ═══════════════════════════════════════════════════════════════════════════════

[env.staging]
vars = { ENVIRONMENT = "staging", LOG_LEVEL = "debug", CORS_ORIGIN = "https://staging.vibe-kanban.pages.dev" }

[env.staging.ai]
binding = "AI"

[[env.staging.d1_databases]]
binding = "DB"
database_name = "vibe-kanban-db-staging"
database_id = "668581ef-bfd4-4c11-84c0-1ba6bd043eb6"
migrations_dir = "migrations"

[[env.staging.r2_buckets]]
binding = "STORAGE"
bucket_name = "vibe-kanban-storage-staging"

[[env.staging.kv_namespaces]]
binding = "CACHE"
id = "43034b4e08de49fdb21a31a65e6018eb"

# ═══════════════════════════════════════════════════════════════════════════════
# PRODUCTION ENVIRONMENT
# ═══════════════════════════════════════════════════════════════════════════════

[env.production]
vars = { ENVIRONMENT = "production", LOG_LEVEL = "info", CORS_ORIGIN = "https://vibe-kanban.pages.dev" }

[env.production.ai]
binding = "AI"

[[env.production.d1_databases]]
binding = "DB"
database_name = "vibe-kanban-db-production"
database_id = "783e3bee-b734-4ff1-8b4b-9cbe9e599ac8"
migrations_dir = "migrations"

[[env.production.r2_buckets]]
binding = "STORAGE"
bucket_name = "vibe-kanban-storage-production"

[[env.production.kv_namespaces]]
binding = "CACHE"
id = "303151e8558541539b348e48a56923a2"

# ─────────────────────────────────────────────────────────────────────────────
# Development Settings
# ─────────────────────────────────────────────────────────────────────────────

[dev]
port = 8787
local_protocol = "http"

# ─────────────────────────────────────────────────────────────────────────────
# Build Configuration
# ─────────────────────────────────────────────────────────────────────────────

[build]
command = "npm run build"
